`````{admonition} Scripts for **Step 3 - Self-calibration of the continuum**:
:class: tip
- <a href="https://github.com/jjspeedie/workflow.2021.1.0690.S/blob/main/step3_continuum_selfcal.py" target="_blank">step3_continuum_selfcal.py</a> # main script
- <a href="https://github.com/jjspeedie/workflow.2021.1.0690.S/blob/main/dictionary_data.py" target="_blank">dictionary_data.py</a> # loads data_dict
- <a href="https://github.com/jjspeedie/workflow.2021.1.0690.S/blob/main/dictionary_disk.py" target="_blank">dictionary_disk.py</a> # loads disk_dict
- <a href="https://github.com/jjspeedie/workflow.2021.1.0690.S/blob/main/selfcal_utils.py" target="_blank">selfcal_utils.py</a> # selfcal functions
`````

# Self-Calibration of SB+LB data

## Summary of path through self-calibration

A table of selected parameters used in each of the tasks, and metrics of the results, broken down by round (columns).

```{image} images/ABAur_BB_concat_shifted_cont_summary.jpg
:alt: ABAur_BB_concat_shifted_cont_summary
:class: mb-1
:width: 100%
:align: center
```

(Note: Empty cells are not meaningless; they mean '', which in CASA either means 'all' or 'nothing'.)

### Explanation of parameter choices

Things that are different from the SB-only self-cal:

**gaincal solint**: Previously in the SB-only self-cal, we used solints that were nice fractions of the scan lengths. This wasn't so possible for the LB+SB self-cal, because the LB scan lengths weren't as consistent. Instead, we reverted to the DSHARP/MAPS solint sequence.

```{figure} images/number-seconds-in-each-scan.png
:alt: number-seconds-in-each-scan
:class: mb-1
:width: 100%
:align: center
For the SB+LB self-cal, the solints (required combine='scan' to ignore scan boundaries and) were: 900s, 360s, 180s, 60s (DSHARP/MAPS sequence).
```

**gaincal combine**: This time it wasn't possible to avoid combine='spw' without sacrificing a lot of data (subjective, but my sense was that there were too many printouts of flagged solutions).

**gaincal refant**: Again chosen by me, using the refant lists generated by the pipeline hif_refant task, shown in the weblog. This time the antenna rankings changed between the different executions, so I calculated an "overall ranking" by multiplying the rank of each antenna in each execution and taking the four with the smallest overall rank. Again it might have been a good idea to specify the pad, if the antennas were moved between executions.

**gaincal minSNR**: Same as SB-only self-cal. Perhaps worth noting that DSHARP decreased the minSNR to 1.5 for their SB+LB self-cal.

**gaincal num flagged solns**: There are a lot more here than there were in the SB-only self-cal, but (!) we also have a lot more data in the SB+LB self-cal. Should be ok?

**applycal applymode**: Here we are trusting the wisdom of DSHARP and copying them (they switch to applymode='calonly' for the SB+LB self-cal). This applies the calibrations, but does NOT flag the data where no calibration solutions are found. This means we do not lose data (so our beam size does not increase), but we also bring with data that has not been calibrated. CASA warns to use this with extreme caution.

**applycal spwmap**: Since gaincal combine includes spw in all rounds, we need a spwmap in all rounds.

**tclean imsize**: Set to go out to the primary beam FWHM (~20 arcsec).

**tclean cellsize**: Set to sample the beam with ~10 cells.

**tclean robust**: In my first SB+LB self-cal venture, I used robust=0.5 as before, but there were a lot of flagged solutions. Ryan suggested we play with the robust parameter. Getting high SNR is important. We can image with a lower robust later for our final images if we want. So for the self-cal, we increase robust to 1.0.

**result rms (uJy/beam, mK)**: Again this nicely decreases. (Note however that these images were not cleaned very deeply, nor are they primary beam corrected. And for reference, the weblog says our final theoretical sensitivity is 12 uJy/beam).

**result peak Inu (mJy/beam)**: Again this more or less increases with each round, except between p4 and ap, where it decreases (to be expected).

**result disk flux (mJy)**: Very strangely, this uniformly decreases with each round. I don't know why. Unexpected.

**result bmin/bmin (mas)**: Since we use applycal applymode='calonly', our beam does not increase. It actually decreases (by ~10 mas), which must be because the PSF becomes cleaner.

**result SNR**: This increases with each round, including between p4 and ap. At the end of this self-cal, we improve by a factor of 1.6.

## Achieved phase solutions as a function of time and antenna (the calibration tables)

All of SB EB1, SB EB2, LB EB1, LB EB2, LB EB3, LB EB4, LB EB5 and LB EB6 were self-calibrated together, but the following plots the solutions separately (to be able to resolve the time axis). Also, only showing p1 and ap rounds, because there's too much manual compilation involved in making these videos.

### LB EB1 through EB 6

```{note}
Jess needs to add here: Videos of calibration tables
```

## Images made after each round

Image achieved after each round, with a large colour bar stretch to exaggerate faint emission.

<video width="100%" controls>
  <source src="../_static/videos/BB_concat_shifted_cont.mp4" type="video/mp4">
</video>

`````{admonition} Thoughts...
:class: tip
The noise outside the disk in the NW-SE directions we saw in the SB-only images remains. It again becomes slightly more uniform with each round of self-cal. Is this due to the inclination of the source on the sky? Our beam position angle is in a similar direction. Perhaps deeper cleaning will help.
`````

```{note}
Jess might add here: Images of model and residuals.
```

```{note}
Jess might add here: Figures showing inspection of flux recovery.
```

## The results, before and after

```{image} images/BB-before-after.gif
:alt: BB-before-after
:class: mb-1
:width: 85%
:align: center
```

We achieve a decrease in rms noise by a factor of 1.6. The peak intensity decreases by about 0.3 mJy/beam. The SNR improves by a factor of 1.5. The outer ring becomes more compact/well-defined. The inner cavity appears emptier; the inner disk appears unchanged.
<!-- There is extended emission around the outside of the outer ring - it is likely not real? -->
